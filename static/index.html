<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research & Content Gathering App - PRODUCTION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .header .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 0;
            min-height: calc(100vh - 200px);
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .content-area {
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .control-section {
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .control-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-idle { background: #6c757d; }
        .status-running { background: #28a745; animation: pulse 1.5s infinite; }
        .status-error { background: #dc3545; }
        .status-paused { background: #ffc107; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .connection-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .results-container {
            margin-top: 20px;
        }

        .result-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-card pre {
            background: white;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9em;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .result-meta span {
            background: white;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #858585;
            margin-right: 10px;
        }

        .log-info { color: #4fc3f7; }
        .log-success { color: #66bb6a; }
        .log-warning { color: #ffa726; }
        .log-error { color: #ef5350; }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .platform-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .platform-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .platform-card.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .platform-card h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .platform-card p {
            font-size: 0.85em;
            color: #6c757d;
        }

        .asset-output {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Research & Content Gathering App</h1>
            <p>Advanced research engine with REAL web search and live parameter controls</p>
            <div class="badge">PRODUCTION READY - Connected to Backend</div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="control-section">
                    <h3>Backend Connection</h3>
                    <div id="connectionStatus" class="connection-status connection-error">
                        Checking connection...
                    </div>
                    <button class="btn btn-secondary" id="testConnectionBtn" style="font-size: 0.9em;">Test Connection</button>
                </div>

                <div class="control-section">
                    <h3>Status</h3>
                    <p><span class="status-indicator status-idle" id="statusIndicator"></span><span id="statusText">Idle</span></p>
                    <p style="margin-top: 8px; font-size: 0.85em; color: #6c757d;">Progress: <span id="progressPercent">0</span>%</p>
                </div>

                <div class="control-section">
                    <h3>Research Query</h3>
                    <div class="form-group">
                        <label for="queryInput">Enter your research topic:</label>
                        <textarea id="queryInput" placeholder="e.g., Latest developments in AI, Climate change research, Quantum computing breakthroughs..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="sourceType">Source Type:</label>
                        <select id="sourceType">
                            <option value="all">All Sources</option>
                            <option value="academic">Academic Papers</option>
                            <option value="news">News Articles</option>
                            <option value="technical">Technical Docs</option>
                            <option value="social">Social Media</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Live Parameters</h3>
                    <div class="slider-group">
                        <label>
                            <span>Depth Level:</span>
                            <span id="depthValue">5</span>
                        </label>
                        <input type="range" id="depthSlider" min="1" max="10" value="5">
                    </div>
                    <div class="slider-group">
                        <label>
                            <span>Max Results:</span>
                            <span id="maxResultsValue">20</span>
                        </label>
                        <input type="range" id="maxResultsSlider" min="5" max="100" value="20" step="5">
                    </div>
                    <div class="slider-group">
                        <label>
                            <span>Relevance Threshold:</span>
                            <span id="relevanceValue">0.7</span>
                        </label>
                        <input type="range" id="relevanceSlider" min="0" max="1" value="0.7" step="0.1">
                    </div>
                    <div class="slider-group">
                        <label>
                            <span>Content Detail:</span>
                            <span id="detailValue">5</span>
                        </label>
                        <input type="range" id="detailSlider" min="1" max="10" value="5">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Content Options</h3>
                    <div class="form-group">
                        <label for="outputFormat">Output Format:</label>
                        <select id="outputFormat">
                            <option value="markdown">Markdown</option>
                            <option value="html">HTML</option>
                            <option value="json">JSON</option>
                            <option value="text">Plain Text</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="summaryLength">Summary Length:</label>
                        <select id="summaryLength">
                            <option value="brief">Brief</option>
                            <option value="moderate" selected>Moderate</option>
                            <option value="detailed">Detailed</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Actions</h3>
                    <button class="btn btn-primary" id="startBtn">üöÄ Start Research</button>
                    <button class="btn btn-secondary" id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
                    <button class="btn btn-success" id="resumeBtn" disabled>‚ñ∂Ô∏è Resume</button>
                    <button class="btn btn-danger" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" id="exportBtn" style="font-size: 0.9em;">üì§ Export</button>
                        <button class="btn btn-secondary" id="saveConfigBtn" style="font-size: 0.9em;">üíæ Save Config</button>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <div class="tabs">
                    <button class="tab active" data-tab="results">üìä Results</button>
                    <button class="tab" data-tab="stats">üìà Statistics</button>
                    <button class="tab" data-tab="logs">üìù Logs</button>
                    <button class="tab" data-tab="build">üìù Content Builder</button>
                    <button class="tab" data-tab="assets">üé® Asset Generator</button>
                </div>

                <div id="results" class="tab-content active">
                    <h2>Research Results</h2>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBar" style="width: 0%;">0%</div>
                    </div>
                    <div class="results-container" id="resultsContainer">
                        <p style="color: #6c757d; text-align: center; margin-top: 50px;">
                            No results yet. Enter a query and click "Start Research" to begin.
                        </p>
                    </div>
                </div>

                <div id="stats" class="tab-content">
                    <h2>Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalQueries">0</div>
                            <div class="stat-label">Total Queries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalResults">0</div>
                            <div class="stat-label">Results Found</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgRelevance">0.00</div>
                            <div class="stat-label">Avg Relevance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="processingTime">0s</div>
                            <div class="stat-label">Processing Time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="sourcesAnalyzed">0</div>
                            <div class="stat-label">Sources Analyzed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="errorCount">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                    <div id="statsDetails"></div>
                </div>

                <div id="logs" class="tab-content">
                    <h2>Activity Logs</h2>
                    <button class="btn btn-secondary" id="clearLogsBtn" style="width: auto; margin-bottom: 15px;">Clear Logs</button>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-timestamp">[00:00:00]</span>
                            <span class="log-success">System initialized and ready</span>
                        </div>
                    </div>
                </div>

                <div id="build" class="tab-content">
                    <h2>Content Builder</h2>
                    <div class="control-section">
                        <h3>Build from Research</h3>
                        <div class="form-group">
                            <label for="contentType">Content Type:</label>
                            <select id="contentType">
                                <option value="article">Article</option>
                                <option value="report">Research Report</option>
                                <option value="summary">Executive Summary</option>
                                <option value="presentation">Presentation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contentTone">Tone:</label>
                            <select id="contentTone">
                                <option value="professional">Professional</option>
                                <option value="academic">Academic</option>
                                <option value="casual">Casual</option>
                                <option value="technical">Technical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="outputFilename">Output Filename (optional):</label>
                            <input type="text" id="outputFilename" placeholder="e.g., research_article.md">
                        </div>
                        <button class="btn btn-primary" id="buildContentBtn">üìù Build Content</button>
                    </div>
                    <div id="builtContent"></div>
                </div>

                <div id="assets" class="tab-content">
                    <h2>Multi-Platform Asset Generator</h2>
                    <p style="color: #6c757d; margin-bottom: 20px;">Generate professional assets for 15+ platforms</p>

                    <div class="control-section">
                        <h3>Platform Selection</h3>
                        <div class="platform-grid">
                            <div class="platform-card" data-platform="youtube">
                                <h4>YouTube</h4>
                                <p>Scripts, thumbnails, descriptions</p>
                            </div>
                            <div class="platform-card" data-platform="instagram">
                                <h4>Instagram</h4>
                                <p>Posts, stories, reels, carousels</p>
                            </div>
                            <div class="platform-card" data-platform="tiktok">
                                <h4>TikTok</h4>
                                <p>Video scripts, hooks, hashtags</p>
                            </div>
                            <div class="platform-card" data-platform="twitter">
                                <h4>Twitter/X</h4>
                                <p>Threads, single posts</p>
                            </div>
                            <div class="platform-card" data-platform="linkedin">
                                <h4>LinkedIn</h4>
                                <p>Professional content</p>
                            </div>
                            <div class="platform-card" data-platform="pinterest">
                                <h4>Pinterest</h4>
                                <p>Pin designs, SEO</p>
                            </div>
                            <div class="platform-card" data-platform="gumroad">
                                <h4>Gumroad</h4>
                                <p>Product listings</p>
                            </div>
                            <div class="platform-card" data-platform="etsy">
                                <h4>Etsy</h4>
                                <p>Shop listings</p>
                            </div>
                            <div class="platform-card" data-platform="web">
                                <h4>Website</h4>
                                <p>Landing pages, blogs</p>
                            </div>
                            <div class="platform-card" data-platform="game">
                                <h4>Game Dev</h4>
                                <p>Design documents</p>
                            </div>
                            <div class="platform-card" data-platform="canva">
                                <h4>Canva</h4>
                                <p>Template specs</p>
                            </div>
                            <div class="platform-card" data-platform="audio">
                                <h4>Audio/Beats</h4>
                                <p>Music production specs</p>
                            </div>
                        </div>
                    </div>

                    <div class="control-section" id="assetConfigSection" style="display: none;">
                        <h3>Asset Configuration</h3>
                        <div class="form-group">
                            <label for="assetTopic">Topic/Product Name:</label>
                            <input type="text" id="assetTopic" placeholder="e.g., My Awesome Product">
                        </div>
                        <div id="platformSpecificOptions"></div>
                        <button class="btn btn-primary" id="generateAssetBtn">üé® Generate Asset</button>
                    </div>

                    <div class="asset-output" id="assetOutput" style="display: none;">
                        <h3>Generated Asset</h3>
                        <pre id="assetContent" style="white-space: pre-wrap;"></pre>
                        <button class="btn btn-secondary" id="copyAssetBtn" style="width: auto; margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MCP_SERVER_URL = 'http://127.0.0.1:8000';

        // State
        let isRunning = false;
        let isPaused = false;
        let currentResearchId = null;
        let pollingInterval = null;
        let stats = {
            totalQueries: 0,
            totalResults: 0,
            avgRelevance: 0,
            processingTime: 0,
            sourcesAnalyzed: 0,
            errors: 0
        };
        let selectedPlatform = null;

        // MCP Client Functions
        async function callMCPTool(toolName, parameters = {}) {
            try {
                const response = await fetch(`${MCP_SERVER_URL}/mcp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: Date.now(),
                        method: 'tools/call',
                        params: {
                            name: toolName,
                            arguments: parameters
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'MCP Tool Error');
                }

                return data.result;
            } catch (error) {
                addLog(`MCP Error (${toolName}): ${error.message}`, 'error');
                throw error;
            }
        }

        // Test connection to backend
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = 'Testing connection...';
            statusEl.className = 'connection-status connection-error';

            try {
                const response = await fetch(`${MCP_SERVER_URL}/`, {
                    method: 'GET',
                });

                if (response.ok) {
                    statusEl.textContent = '‚úì Connected to MCP Server';
                    statusEl.className = 'connection-status connection-success';
                    addLog('Successfully connected to backend server', 'success');
                    return true;
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                statusEl.textContent = `‚úó Connection Failed: ${error.message}`;
                statusEl.className = 'connection-status connection-error';
                addLog(`Connection test failed: ${error.message}`, 'error');
                return false;
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Slider updates
        const sliders = {
            depth: { slider: 'depthSlider', value: 'depthValue' },
            maxResults: { slider: 'maxResultsSlider', value: 'maxResultsValue' },
            relevance: { slider: 'relevanceSlider', value: 'relevanceValue' },
            detail: { slider: 'detailSlider', value: 'detailValue' }
        };

        Object.entries(sliders).forEach(([key, elements]) => {
            const slider = document.getElementById(elements.slider);
            const valueDisplay = document.getElementById(elements.value);
            slider.addEventListener('input', async (e) => {
                valueDisplay.textContent = e.target.value;
                if (isRunning && !isPaused) {
                    await updateLiveParameters();
                }
            });
        });

        // Log function
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Update status
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // Start research
        document.getElementById('startBtn').addEventListener('click', async () => {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('Please enter a research query');
                return;
            }

            isRunning = true;
            isPaused = false;
            updateStatus('running', 'Running');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = true;

            addLog('Starting research task...', 'info');
            document.getElementById('resultsContainer').innerHTML = '<p style="color: #6c757d; text-align: center;">Research in progress...</p>';

            try {
                const params = {
                    query: query,
                    source_type: document.getElementById('sourceType').value,
                    depth: parseInt(document.getElementById('depthSlider').value),
                    max_results: parseInt(document.getElementById('maxResultsSlider').value),
                    relevance_threshold: parseFloat(document.getElementById('relevanceSlider').value),
                    detail_level: parseInt(document.getElementById('detailSlider').value),
                    output_format: document.getElementById('outputFormat').value,
                    summary_length: document.getElementById('summaryLength').value
                };

                addLog(`Query: "${query}"`, 'info');
                addLog(`Parameters: Depth=${params.depth}, MaxResults=${params.max_results}, Relevance=${params.relevance_threshold}`, 'info');

                // Call real MCP backend
                const result = await callMCPTool('start_research', params);
                addLog('Research task submitted to backend', 'success');

                // Start polling for status
                startPolling();

            } catch (error) {
                addLog(`Error starting research: ${error.message}`, 'error');
                updateStatus('error', 'Error');
                stopResearch();
            }
        });

        // Polling for status updates
        function startPolling() {
            pollingInterval = setInterval(async () => {
                try {
                    const statusResult = await callMCPTool('get_research_status');
                    const statusData = JSON.parse(statusResult.content[0].text);

                    // Update progress
                    const progress = statusData.progress || 0;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('progressBar').textContent = `${progress}%`;
                    document.getElementById('progressPercent').textContent = progress;

                    // Check if completed
                    if (!statusData.is_running && progress === 100) {
                        addLog('Research completed! Fetching results...', 'success');
                        await fetchResults();
                        await fetchStats();
                        stopPolling();
                        stopResearch();
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 1000); // Poll every second
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Fetch results
        async function fetchResults() {
            try {
                const format = document.getElementById('outputFormat').value;
                const result = await callMCPTool('get_results', { format: format });
                const resultsData = JSON.parse(result.content[0].text);

                displayResults(resultsData.results || resultsData.result);
                addLog(`Retrieved ${stats.totalResults} results`, 'success');
            } catch (error) {
                addLog(`Error fetching results: ${error.message}`, 'error');
            }
        }

        // Display results
        function displayResults(resultsText) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = `
                <h4>Research Results</h4>
                <pre>${resultsText}</pre>
            `;
            container.appendChild(resultCard);
        }

        // Fetch stats
        async function fetchStats() {
            try {
                const result = await callMCPTool('get_statistics');
                const statsData = JSON.parse(result.content[0].text);

                stats = statsData.statistics || statsData;
                updateStatsDisplay();
            } catch (error) {
                addLog(`Error fetching stats: ${error.message}`, 'error');
            }
        }

        function updateStatsDisplay() {
            document.getElementById('totalQueries').textContent = stats.total_queries || stats.totalQueries || 0;
            document.getElementById('totalResults').textContent = stats.total_results || stats.totalResults || 0;
            document.getElementById('avgRelevance').textContent = (stats.avg_relevance || stats.avgRelevance || 0).toFixed(2);
            document.getElementById('processingTime').textContent = `${(stats.processing_time || stats.processingTime || 0).toFixed(1)}s`;
            document.getElementById('sourcesAnalyzed').textContent = stats.sources_analyzed || stats.sourcesAnalyzed || 0;
            document.getElementById('errorCount').textContent = stats.errors || 0;
        }

        // Pause research
        document.getElementById('pauseBtn').addEventListener('click', async () => {
            try {
                await callMCPTool('pause_research');
                isPaused = true;
                updateStatus('paused', 'Paused');
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = false;
                addLog('Research paused', 'warning');
                stopPolling();
            } catch (error) {
                addLog(`Error pausing research: ${error.message}`, 'error');
            }
        });

        // Resume research
        document.getElementById('resumeBtn').addEventListener('click', async () => {
            try {
                await callMCPTool('resume_research');
                isPaused = false;
                updateStatus('running', 'Running');
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('resumeBtn').disabled = true;
                addLog('Research resumed', 'info');
                startPolling();
            } catch (error) {
                addLog(`Error resuming research: ${error.message}`, 'error');
            }
        });

        // Stop research
        document.getElementById('stopBtn').addEventListener('click', async () => {
            try {
                await callMCPTool('stop_research');
                addLog('Research stopped by user', 'warning');
                stopPolling();
                stopResearch();
            } catch (error) {
                addLog(`Error stopping research: ${error.message}`, 'error');
            }
        });

        function stopResearch() {
            isRunning = false;
            isPaused = false;
            updateStatus('idle', 'Idle');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        // Live parameter updates
        async function updateLiveParameters() {
            try {
                const params = {
                    depth: parseInt(document.getElementById('depthSlider').value),
                    max_results: parseInt(document.getElementById('maxResultsSlider').value),
                    relevance_threshold: parseFloat(document.getElementById('relevanceSlider').value),
                    detail_level: parseInt(document.getElementById('detailSlider').value)
                };

                await callMCPTool('update_parameters', params);
                addLog(`Parameters updated live: Depth=${params.depth}, MaxResults=${params.max_results}`, 'info');
            } catch (error) {
                addLog(`Error updating parameters: ${error.message}`, 'error');
            }
        }

        // Export results
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                const format = document.getElementById('outputFormat').value;
                const filename = `research_results_${Date.now()}.${format === 'markdown' ? 'md' : format}`;

                const result = await callMCPTool('export_results', {
                    filename: filename,
                    format: format
                });

                addLog(`Results exported to ${filename}`, 'success');
                alert(`Results exported to ${filename}`);
            } catch (error) {
                addLog(`Export error: ${error.message}`, 'error');
            }
        });

        // Save configuration
        document.getElementById('saveConfigBtn').addEventListener('click', async () => {
            try {
                const name = prompt('Enter configuration name:');
                if (!name) return;

                const description = prompt('Enter description (optional):') || 'Saved configuration';

                await callMCPTool('save_configuration', {
                    name: name,
                    description: description
                });

                addLog(`Configuration saved as "${name}"`, 'success');
            } catch (error) {
                addLog(`Error saving config: ${error.message}`, 'error');
            }
        });

        // Build content
        document.getElementById('buildContentBtn').addEventListener('click', async () => {
            try {
                const contentType = document.getElementById('contentType').value;
                const tone = document.getElementById('contentTone').value;
                const outputFile = document.getElementById('outputFilename').value.trim() || null;

                addLog(`Building ${contentType} with ${tone} tone...`, 'info');

                const result = await callMCPTool('build_content', {
                    content_type: contentType,
                    tone: tone,
                    output_file: outputFile
                });

                const resultData = JSON.parse(result.content[0].text);

                const builtContent = document.getElementById('builtContent');
                builtContent.innerHTML = `
                    <div class="result-card">
                        <h4>Generated ${contentType}</h4>
                        <div class="result-meta">
                            <span>Tone: ${tone}</span>
                            ${outputFile ? `<span>Saved to: ${outputFile}</span>` : ''}
                        </div>
                        <pre>${resultData.content || resultData.result || 'Content generated successfully'}</pre>
                    </div>
                `;

                addLog(`Built ${contentType} successfully`, 'success');
            } catch (error) {
                addLog(`Error building content: ${error.message}`, 'error');
            }
        });

        // Platform selection
        document.querySelectorAll('.platform-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.platform-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedPlatform = card.dataset.platform;

                document.getElementById('assetConfigSection').style.display = 'block';
                updatePlatformOptions(selectedPlatform);
            });
        });

        // Update platform-specific options
        function updatePlatformOptions(platform) {
            const optionsDiv = document.getElementById('platformSpecificOptions');

            const platformOptions = {
                youtube: `
                    <div class="form-group">
                        <label>Asset Type:</label>
                        <select id="assetTypeSelect">
                            <option value="video_script">Video Script</option>
                            <option value="thumbnail_template">Thumbnail Template</option>
                            <option value="description">Description</option>
                            <option value="tags">SEO Tags</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Video Duration:</label>
                        <select id="durationSelect">
                            <option value="1min">1 minute (Short)</option>
                            <option value="5min">5 minutes</option>
                            <option value="10min">10 minutes</option>
                            <option value="15min">15 minutes</option>
                            <option value="30min">30 minutes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Style:</label>
                        <select id="styleSelect">
                            <option value="tutorial">Tutorial</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="educational">Educational</option>
                            <option value="vlog">Vlog</option>
                        </select>
                    </div>
                `,
                instagram: `
                    <div class="form-group">
                        <label>Post Type:</label>
                        <select id="postTypeSelect">
                            <option value="feed">Feed Post</option>
                            <option value="story">Story</option>
                            <option value="reel">Reel</option>
                            <option value="carousel">Carousel</option>
                        </select>
                    </div>
                `,
                tiktok: `
                    <div class="form-group">
                        <label>Style:</label>
                        <select id="styleSelect">
                            <option value="entertainment">Entertainment</option>
                            <option value="educational">Educational</option>
                            <option value="tutorial">Tutorial</option>
                        </select>
                    </div>
                `,
                twitter: `<p style="color: #6c757d; font-size: 0.9em;">Will generate an engaging Twitter thread</p>`,
                linkedin: `
                    <div class="form-group">
                        <label>Post Type:</label>
                        <select id="postTypeSelect">
                            <option value="professional">Professional Update</option>
                            <option value="storytelling">Storytelling</option>
                            <option value="listicle">Listicle</option>
                        </select>
                    </div>
                `,
                pinterest: `
                    <div class="form-group">
                        <label>Pin Type:</label>
                        <select id="pinTypeSelect">
                            <option value="how_to">How-to Guide</option>
                            <option value="infographic">Infographic</option>
                            <option value="product">Product Pin</option>
                            <option value="quote">Quote</option>
                        </select>
                    </div>
                `,
                gumroad: `
                    <div class="form-group">
                        <label>Product Type:</label>
                        <select id="productTypeSelect">
                            <option value="course">Course</option>
                            <option value="ebook">E-book</option>
                            <option value="template">Template</option>
                            <option value="software">Software</option>
                        </select>
                    </div>
                `,
                etsy: `
                    <div class="form-group">
                        <label>Category:</label>
                        <select id="categorySelect">
                            <option value="art">Art</option>
                            <option value="craft">Craft</option>
                            <option value="digital">Digital Product</option>
                            <option value="planner">Planner</option>
                        </select>
                    </div>
                `,
                web: `
                    <div class="form-group">
                        <label>Asset Type:</label>
                        <select id="assetTypeSelect">
                            <option value="landing_page">Landing Page</option>
                            <option value="blog_post_template">Blog Post</option>
                            <option value="faq_section">FAQ Section</option>
                        </select>
                    </div>
                `,
                game: `
                    <div class="form-group">
                        <label>Genre:</label>
                        <select id="genreSelect">
                            <option value="action">Action</option>
                            <option value="rpg">RPG</option>
                            <option value="puzzle">Puzzle</option>
                            <option value="strategy">Strategy</option>
                        </select>
                    </div>
                `,
                canva: `<p style="color: #6c757d; font-size: 0.9em;">Will generate Canva template specifications</p>`,
                audio: `
                    <div class="form-group">
                        <label>Asset Type:</label>
                        <select id="assetTypeSelect">
                            <option value="beat">Beat/Music Specs</option>
                            <option value="voiceover">Voiceover Script</option>
                            <option value="podcast">Podcast Episode</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Genre/Mood:</label>
                        <input type="text" id="genreInput" placeholder="e.g., hiphop, energetic, calm">
                    </div>
                `
            };

            optionsDiv.innerHTML = platformOptions[platform] || '';
        }

        // Generate asset
        document.getElementById('generateAssetBtn').addEventListener('click', async () => {
            if (!selectedPlatform) {
                alert('Please select a platform first');
                return;
            }

            const topic = document.getElementById('assetTopic').value.trim();
            if (!topic) {
                alert('Please enter a topic/product name');
                return;
            }

            try {
                addLog(`Generating ${selectedPlatform} asset...`, 'info');

                let toolName = '';
                let params = { topic: topic };

                // Map platform to tool
                const platformTools = {
                    youtube: 'generate_youtube_assets',
                    instagram: 'generate_instagram_assets',
                    tiktok: 'generate_tiktok_script',
                    twitter: 'generate_twitter_thread',
                    linkedin: 'generate_linkedin_post',
                    pinterest: 'generate_pinterest_pin',
                    gumroad: 'generate_gumroad_listing',
                    etsy: 'generate_etsy_listing',
                    web: 'generate_web_assets',
                    game: 'generate_game_assets',
                    canva: 'generate_canva_specs',
                    audio: 'generate_beat_specs'
                };

                toolName = platformTools[selectedPlatform];

                // Add platform-specific parameters
                const assetTypeEl = document.getElementById('assetTypeSelect');
                const styleEl = document.getElementById('styleSelect');
                const durationEl = document.getElementById('durationSelect');
                const postTypeEl = document.getElementById('postTypeSelect');
                const productTypeEl = document.getElementById('productTypeSelect');
                const categoryEl = document.getElementById('categorySelect');
                const genreEl = document.getElementById('genreSelect');
                const genreInputEl = document.getElementById('genreInput');
                const pinTypeEl = document.getElementById('pinTypeSelect');

                if (assetTypeEl) params.asset_type = assetTypeEl.value;
                if (styleEl) params.style = styleEl.value;
                if (durationEl) params.duration = durationEl.value;
                if (postTypeEl) params.post_type = postTypeEl.value;
                if (productTypeEl) params.product_type = productTypeEl.value;
                if (categoryEl) params.category = categoryEl.value;
                if (genreEl) params.genre = genreEl.value;
                if (genreInputEl && genreInputEl.value) params.genre = genreInputEl.value;
                if (pinTypeEl) params.pin_type = pinTypeEl.value;

                // Special handling for different platforms
                if (selectedPlatform === 'gumroad') {
                    params.product_name = topic;
                    delete params.topic;
                } else if (selectedPlatform === 'etsy') {
                    params.product_name = topic;
                    delete params.topic;
                } else if (selectedPlatform === 'game') {
                    params.game_name = topic;
                    delete params.topic;
                } else if (selectedPlatform === 'web') {
                    params.product_name = topic;
                    delete params.topic;
                } else if (selectedPlatform === 'audio' && assetTypeEl?.value === 'beat') {
                    toolName = 'generate_beat_specs';
                    params = { genre: genreInputEl?.value || 'hiphop', mood: 'energetic' };
                } else if (selectedPlatform === 'audio' && assetTypeEl?.value === 'voiceover') {
                    toolName = 'generate_voiceover_script';
                    params = { content_type: 'commercial', duration: 60 };
                } else if (selectedPlatform === 'audio' && assetTypeEl?.value === 'podcast') {
                    toolName = 'generate_podcast_assets';
                    params = { topic: topic };
                }

                const result = await callMCPTool(toolName, params);
                const resultData = JSON.parse(result.content[0].text);

                // Display result
                const assetOutput = document.getElementById('assetOutput');
                const assetContent = document.getElementById('assetContent');

                assetContent.textContent = JSON.stringify(resultData.result || resultData, null, 2);
                assetOutput.style.display = 'block';

                addLog(`${selectedPlatform} asset generated successfully`, 'success');
            } catch (error) {
                addLog(`Error generating asset: ${error.message}`, 'error');
            }
        });

        // Copy asset to clipboard
        document.getElementById('copyAssetBtn').addEventListener('click', () => {
            const content = document.getElementById('assetContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                addLog('Asset copied to clipboard', 'success');
                alert('Copied to clipboard!');
            });
        });

        // Clear logs
        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            document.getElementById('logContainer').innerHTML = '';
            addLog('Logs cleared', 'info');
        });

        // Test connection button
        document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

        // Initialize - test connection on load
        window.addEventListener('load', async () => {
            addLog('Research & Content Gathering App loaded', 'success');
            addLog('Testing backend connection...', 'info');
            await testConnection();
        });
    </script>
</body>
</html>
